# Analysis Tools

このディレクトリには、GPRデータの解析・評価ツールが含まれています。ピーク検出、フィッティング、勾配解析、エコー抽出などの解析手法を提供します。

## 概要

解析ツールは、処理されたGPRデータから有用な情報を抽出し、定量的な評価を行うためのツールです。これらのツールは、速度解析、マイグレーション、イメージング処理の基盤となる重要な機能を提供します。

### 主な機能
- ピーク検出・解析
- 双曲線フィッティング
- 勾配解析
- エコー抽出・解析
- 統計的評価

## 含まれるツール

### ピーク・フィッティング解析
- **`k_detect_peak.py`** - A-scanデータのピーク検出・解析
- **`k_fitting.py`** - 双曲線フィッティング（回折パターン解析）
- **`fitting.py`** - 双曲線フィッティング（レガシー版）

### 勾配・エコー解析
- **`k_gradient.py`** - 勾配計算・解析
- **`extract_subsrface_echo.py`** - 地下エコーの抽出・解析

## 使用方法

### ピーク検出・解析
```bash
# A-scanデータのピーク検出
python -m tools.analysis.k_detect_peak config.json

# 双曲線フィッティング
python -m tools.analysis.k_fitting config.json

# レガシーフィッティング
python -m tools.analysis.fitting config.json
```

### 勾配・エコー解析
```bash
# 勾配解析
python -m tools.analysis.k_gradient config.json

# 地下エコーの抽出
python -m tools.analysis.extract_subsrface_echo config.json
```

## 解析手法の詳細

### ピーク検出 (k_detect_peak.py)
A-scanデータから反射波のピークを自動検出します：

- **しきい値法**: 指定したしきい値以上の振幅を持つピークを検出
- **相対しきい値法**: 最大振幅に対する相対値でピークを検出
- **ピーク特性解析**: 振幅、位置、幅などの特性を解析

### 双曲線フィッティング (k_fitting.py)
点散乱体からの回折パターンを双曲線でフィッティングします：

```
t² = t₀² + (x-x₀)²/v²
```

- **パラメータ推定**: t₀（頂点時間）、x₀（頂点位置）、v（速度）
- **フィッティング品質**: 相関係数、残差解析
- **不確実性評価**: パラメータの信頼区間

### 勾配解析 (k_gradient.py)
データの空間的・時間的勾配を計算します：

- **空間勾配**: ∂f/∂x
- **時間勾配**: ∂f/∂t
- **勾配方向**: 最大勾配の方向
- **勾配強度**: 勾配の大きさ

### エコー抽出 (extract_subsrface_echo.py)
地下構造からの反射エコーを抽出・解析します：

- **エコー分離**: 直達波と反射波の分離
- **エコー特性**: 振幅、位相、到達時間
- **品質評価**: S/N比、相関係数

## 設定ファイル例

```json
{
    "input_file": "processed_data.out",
    "output_dir": "analysis_results/",
    "analysis_params": {
        "peak_detection": {
            "threshold": 0.5e-3,
            "method": "relative",
            "min_distance": 5
        },
        "fitting": {
            "method": "least_squares",
            "initial_guess": [50, 25, 0.1],
            "bounds": [[0, 0, 0.05], [100, 50, 0.2]]
        },
        "gradient": {
            "method": "sobel",
            "sigma": 1.0
        }
    }
}
```

## 典型的な解析フロー

### 反射体解析
1. **データ前処理**: ノイズ除去、ゲイン補正
2. **ピーク検出**: 反射波ピークの自動検出
3. **フィッティング**: 双曲線パターンのフィッティング
4. **パラメータ推定**: 散乱体位置・速度の推定
5. **品質評価**: フィッティング精度の評価
6. **結果保存**: 解析結果の保存・可視化

### 構造解析
1. **勾配計算**: 空間的・時間的勾配の計算
2. **エコー抽出**: 地下構造エコーの抽出
3. **特性解析**: エコー特性の定量化
4. **統計評価**: 複数測定の統計処理
5. **結果統合**: 総合的な構造推定

## 解析精度の向上

### データ品質
- **S/N比の改善**: 適切な前処理の実施
- **サンプリング**: 十分な時間・空間分解能
- **測定条件**: 適切なアンテナ配置

### パラメータ調整
- **しきい値設定**: データ特性に応じた適切な設定
- **フィッティング初期値**: 物理的に合理的な初期推定
- **境界条件**: 適切な制約条件の設定

## 関連ツール

- **velocity_analysis/**: 速度推定での利用
- **migration_imaging/**: マイグレーション処理での利用
- **signal_processing/**: 前処理での組み合わせ
- **visualization/**: 結果の可視化

## 注意事項

- ピーク検出では、ノイズレベルに応じてしきい値を適切に設定してください
- 双曲線フィッティングでは、十分なオフセット範囲のデータが必要です
- 勾配計算では、データの空間サンプリング間隔を考慮してください
- エコー抽出では、直達波の影響を適切に除去してください
- 複数の解析手法を組み合わせて、結果の信頼性を向上させてください
- 解析結果の物理的妥当性を常に確認してください